{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-md-10">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="{% url 'income' %}">Income</a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            My Income
          </li>
        </ol>
      </nav>
    </div>

    <div class="col-md-2 text-right">
      <a href="{% url 'add-income' %}" class="btn btn-outline-primary rounded-pill">Add Income</a>
    </div>
  </div>

  <div class="container"> 
    {% include 'partials/messages.html' %}

    {% if income.count %}
    <div class="row">
      <!-- Center the chart -->
      <div class="row justify-content-center mb-2">
        <div class="col-md-11">
          <canvas id="myChart" class="chart-canvas"></canvas>
        </div>
      </div>

      <!-- Category Cards -->
      <div class="row justify-content-center mb-2" id="categoryCards">
        <!-- Cards will be inserted here by JavaScript -->
      </div>

      <div class="col-md-12 text-center">
        <div class="card mb-3 category-card">
          <div class="card-body" style="background-color: #00A86B; color: white;">
            <h5 class="card-title">Total Income</h5>
            <p class="card-text">({{ currency }}) <span id="totalIncome"></span></p>
          </div>
        </div>
      </div>

      <div class="col-md-8">
        <div class="form-group mt-1 mb-2">
          <label for="filter">Filter by:</label>
          <select class="form-control search-box" id="filter" onchange="applyFilter()">
              <option value="all" {% if filter_value == 'all' %}selected{% endif %}>All</option>
              <option value="daily" {% if filter_value == 'daily' %}selected{% endif %}>Daily</option>
              <option value="weekly" {% if filter_value == 'weekly' %}selected{% endif %}>Weekly</option>
              <option value="monthly" {% if filter_value == 'monthly' %}selected{% endif %}>Monthly</option>
              <option value="3months" {% if filter_value == '3months' %}selected{% endif %}>Last 3 Months</option>
              <option value="6months" {% if filter_value == '6months' %}selected{% endif %}>Last 6 Months</option>
              <option value="yearly" {% if filter_value == 'yearly' %}selected{% endif %}>Yearly</option>
          </select>
      </div>
      </div>
      <div class="col-md-4">
        <div class="form-group mt-4 mb-4 ">
          <input type="text" class="form-control search-box " id="searchField" placeholder="Search">
        </div>
      </div>
    </div>

    <div class="app-table ">
      <table class="table table-stripped table-hover ">
        <thead>
          <tr>
            <th>Amount ({{ currency }})</th>
            <th>Source</th>
            <th>Description</th>
            <th>Date</th>
            <th>Options</th>
          </tr>
        </thead>
        <tbody>
          {% for income in page_obj %}
          <tr>
            <td>{{ income.amount }}</td>
            <td>{{ income.source }}</td>
            <td>{{ income.description }}</td>
            <td>{{ income.date }}</td>
            <td>
              <a href="{% url 'income-edit' income.id %}" class="btn btn-outline-success btn-sm rounded-pill">Edit</a>
              <button type="button" class="btn btn-outline-danger btn-sm rounded-pill" data-bs-toggle="modal" data-bs-target="#deleteModal{{ income.id }}">Delete</button>
            </td>
          </tr>
          <div class="modal fade" id="deleteModal{{ income.id }}" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="deleteModalLabel{{ income.id }}" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="deleteModalLabel{{ income.id }}">Confirm Delete</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  Are you sure you want to delete this income record?
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Cancel</button>
                  <form action="{% url 'income-delete' income.id %}" method="post" style="display: inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger rounded-pill">Delete</button>
                  </form>
                </div>
              </div>
            </div>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="table-output">
      <table class="table table-stripped table-hover">
        <thead>
          <tr>
            <th>Amount ({{ currency }})</th>
            <th>Source</th>
            <th>Description</th>
            <th>Date</th>
            <th></th>
          </tr>
        </thead>
        <tbody class="table-body">
        </tbody>
      </table>
    </div>

    <p class="no-results" style="display: none;">No results</p>

    <div class="pagination-container ">
      <div class="pagination justify-content-center ">
        Showing page {{page_obj.number}} of {{ page_obj.paginator.num_pages }}
      </div>
      <ul class="pagination align-right float-right mr-auto mt-2 justify-content-center ">
        {% if page_obj.has_previous %}
        <li {% if page_obj.number == 1 %} class="page-item active" {% endif %}><a class="page-link" href="?page=1">&laquo; 1</a></li>
        <li class="page-item"> <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
        {% endif %}
  
        {% for i in page_obj.paginator.page_range %}
            {% if page_obj.number == i %}
            <li class="page-item active"><a class="page-link">{{ i }}</a></li>
            {% else %}
            <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
            {% endif %}
            {% endfor %}
        
        {% if page_obj.has_next %}
        <li class="page-item"> <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
        <!-- <li class="page-item"> <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">{{ page_obj.paginator.num_pages}} &raquo;</a></li> -->
        {% endif %}
  
  
      </ul>
      {% endif %}
        </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js"></script>

<script src="{% static 'js/searchIncome.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    fetch("{% url 'income_category_summary' %}")
        .then(response => response.json())
        .then(data => {
            const categories = Object.keys(data.income_category_data);
            const amounts = Object.values(data.income_category_data);

            const totalIncome = amounts.reduce((acc, amount) => acc + amount, 0);
            document.getElementById('totalIncome').textContent = totalIncome.toFixed(2);

            // Base color in HSL format
            const baseColorHSL = 'hsl(159, 48%, 52%)'; // Mint green

            // Generate shades of mint green
            const shadesOfMintGreen = categories.map((_, index) => {
                // Create varying shades by adjusting lightness
                const lightness = 52 - (index * 30 / (categories.length - 1)); // Adjust range for lighter or darker shades
                return `hsl(159, 48%, ${lightness}%)`; // Mint green color in HSL format
            });

            const ctx = document.getElementById('myChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar', // Change this to 'line', 'pie', etc., as needed
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'Income by Source',
                        data: amounts,
                        backgroundColor: shadesOfMintGreen, 
                        borderColor: shadesOfMintGreen.map(color => color.replace(/(\d+%)/, '70%')), // Darker border color
                        borderWidth: 0 // Increase border width for better contrast
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Adjust this if needed
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(tooltipItem) {
                                    return `${tooltipItem.label}: $${tooltipItem.raw.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });

            const cardContainer = document.getElementById('categoryCards');
            cardContainer.innerHTML = ''; // Clear existing cards

            categories.forEach((category, index) => {
                const amount = amounts[index];
                const color = shadesOfMintGreen[index];
                
                // Create a card element
                const card = document.createElement('div');
                card.className = 'col-md-4';  // Adjust column size
                card.innerHTML = `
                    <div class="card mb-3 category-card">
                        <div class="card-body" style="background-color: ${color}; color: white;">
                            <h5 class="card-title">${category}</h5>
                            <p class="card-text">({{ currency }}) ${amount.toFixed(2)}</p>
                        </div>
                    </div>
                `;
                
                cardContainer.appendChild(card);
            });
        })
        .catch(error => console.error('Error fetching income source data:', error));
  });
</script>


<script>
  function applyFilter() {
      const filter = document.getElementById('filter').value;
      window.location.href = `?filter=${filter}`;
  }
</script>

<style>
  .search-box{
    border-radius: 20px !important;
  }

  table {
  border-collapse: collapse;
  border-radius: 1em;
  overflow: hidden;
  }
  
  .card {
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
    transition: transform 0.2s, box-shadow 0.2s; 
  }

  .card-body {
    border-radius: 12px;
  }

  .card:hover {
    transform: scale(1.05); /* Slightly increase scale */
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3); /* Increase shadow on hover */
  }
  
  .chart-canvas {
    height: 300px; /* Adjust as needed */
  }
  
  .table-hover tbody tr:hover {
    background-color: #f1f1f1;
  }
  
  .pagination-container {
    margin-top: 20px;
  }
  
  .pagination a {
    color: #007bff;
  }
</style>
  
{% endblock content %}
